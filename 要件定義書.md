# 布団鯖ヒット＆ブロー 要件定義（最新版）

## 概要
布団鯖メンバー向けのオンライン対戦型ヒット＆ブロー。6種類のアイコンから4つの並びを推理し、リアルタイムに競う。Ably を用いたフロントエンド完結型の構成。

---

## 機能要件
### ゲーム基本ルール
- 正解は **6種類のアイコンから4つを順不同で並べた組み合わせ**。
- プレイヤーは4つのアイコンを選んで提出。
- **Hit**: アイコンと位置が一致。**Blow**: アイコンのみ一致。
- 60秒/ターン。時間切れ時は自動入力を送信。
- 誰かが Hit=4 を達成したら勝利。終了時に正解を公開。
- 過去の回答履歴は全員に共有。

### プレイヤー管理
- トップページで名前＋パスワード入力でロビー入室。ホストがゲーム開始。
- 途中参加は観戦モードで合流（進行中に乱入しても盤面を壊さない）。
- ブラウザ/タブを閉じたら `player:leave` を送信しロビーから除外。
- プレイヤー順はホストが確定して配信。全クライアントで同じ順序を維持。

### ゲームフロー
1. トップで名前/パスワード入力 → ロビー入室。
2. ホストがルーム作成 → プレイヤー順を確定し配信。
3. ホストがゲーム開始 → 回答生成・ターン=0・履歴リセットを配信。
4. ターンプレイヤーが 60 秒以内に回答（時間切れは自動回答）。
5. ホストが回答を採点し、結果と次ターンを全員に配信。
6. 勝者が出たらゲーム終了 → 正解と勝者を表示 → 自動でロビーへ戻る。

### 終了条件
- Hit=4 のプレイヤーが出た時点で終了。
- （拡張余地）全員が一定回数回答したら終了。

---

## 非機能要件
- 同時接続: 10人程度までを想定。
- レスポンシブ対応（スマートフォン/PC）。
- SPA として GitHub Pages 上で動作。`404.html` による直アクセス/リロード耐性あり。
- APIキーは `.env` で管理。Actions では `secrets.VITE_ABLY_API_KEY` をビルド時に注入。

---

## 画面仕様（概要）
1. **トップ**  
   - ゲーム名表示、コンセプトコピー。  
   - 名前入力、パスワード入力、ロビー入室ボタン。
2. **ロビー**  
   - 参加者一覧、ホスト表示、ルール/ステータスカード。  
   - ホストのみ「部屋を立てる」「ゲーム開始」ボタン。  
   - 途中参加者は観戦モードへ。
3. **ゲーム**  
   - ターン表示、残り時間、最新結果。  
   - アイコン選択グリッド（6種から4つ）。  
   - 回答履歴（全員共有）。  
   - 観戦モード表示。
4. **結果**  
   - 勝者表示、正解アイコン表示。  
   - 一定時間後にロビーへ自動遷移。

---

## データ構造（抜粋）
```ts
type GameStatus = 'lobby' | 'preparing' | 'playing' | 'finished'

type Player = {
  id: string
  name: string
  answerCount: number
  isCorrect: boolean
  isHost: boolean
  isSpectator: boolean
}

type AnswerHistory = {
  playerId: string
  playerName: string
  guess: number[]    // アイコンID (1-6) の配列
  hit: number
  blow: number
  timestamp: number
}
```

---

## 技術構成
- React + Vite + TypeScript
- Zustand（クライアント状態管理）
- Tailwind CSS（スタイリング）
- Ably Realtime（イベント配信／サーバーレス構成）
- GitHub Pages（SPAホスティング、404 fallback）

---

## デプロイ・環境変数
- `main` への push で Actions がビルド → `dist/index.html` を `dist/404.html` にコピー → Pages に公開。
- 必須環境変数: `VITE_ABLY_API_KEY`

---

## 今後の検討
- 再接続時の自動リカバリ強化
- 不正回答のさらに厳格なバリデーション
- 観戦者向けUI拡充・エモート等
